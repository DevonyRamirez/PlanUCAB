<div class="calendario-semanal">
  <aside class="calendario-semanal__sidebar">
    <div class="calendario-semanal__sidebar-content">
      <app-calendario-mensual (crearEvento)="abrirModalCrear()" (crearHorario)="abrirModalCrearHorario()" (crearEvaluacion)="abrirModalCrearEvaluacion()" (verMaterias)="abrirModalMaterias()" (fechaSeleccionada)="navegarAFecha($event)"></app-calendario-mensual>
    </div>
    <div class="calendario-semanal__sidebar-footer">
      <button (click)="cerrarSesion()" class="calendario-semanal__logout-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        <span>Cerrar Sesión</span>
      </button>
    </div>
  </aside>

  <main class="calendario-semanal__main">
    <div class="calendar-toolbar">
      <button (click)="anteriorSemana()" class="calendar-toolbar__nav-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
          <path d="M24,12A12,12,0,1,0,12,24,12.013,12.013,0,0,0,24,12ZM8,12a2.993,2.993,0,0,1,.752-1.987c.291-.327.574-.637.777-.84L12.353,6.3a1,1,0,0,1,1.426,1.4L10.95,10.58c-.187.188-.441.468-.7.759a1,1,0,0,0,0,1.323c.258.29.512.57.693.752L13.779,16.3a1,1,0,0,1-1.426,1.4L9.524,14.822c-.2-.2-.48-.507-.769-.833A2.99,2.99,0,0,1,8,12Z"/>
        </svg>
      </button>
      <div class="calendar-toolbar__date-range">
        {{ formatDateRange() }}
      </div>
      <button (click)="siguienteSemana()" class="calendar-toolbar__nav-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
          <path d="M0,12A12,12,0,1,0,12,0,12.013,12.013,0,0,0,0,12Zm16,0a2.993,2.993,0,0,1-.752,1.987c-.291.327-.574.637-.777.84L11.647,17.7a1,1,0,1,1-1.426-1.4L13.05,13.42c.187-.188.441-.468.7-.759a1,1,0,0,0,0-1.323c-.258-.29-.512-.57-.693-.752L10.221,7.7a1,1,0,1,1,1.426-1.4l2.829,2.879c.2.2.48.507.769.833A2.99,2.99,0,0,1,16,12Z"/>
        </svg>
      </button>
    </div>

    <div class="calendar">
      <!-- Mensaje cuando no hay información -->
      <div *ngIf="!tieneInformacion()" class="empty-calendar-message">
        <div class="empty-calendar-content">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="empty-calendar-icon">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
          <p class="empty-calendar-text">No tiene información registrada en la agenda. Presione "Crear" para iniciar.</p>
        </div>
      </div>

      <div *ngIf="tieneInformacion()" class="calendar-content">
        <div class="calendar__hours-label"></div>
        <div *ngFor="let d of diasSemana()" class="calendar__day-label">
          {{ formatDayName(d) }}
        </div>

        <!-- Columna de horas -->
        <div class="hours-col">
          <div *ngFor="let h of horas" class="hours-col__cell">{{ formatHour(h) }}</div>
        </div>

        <!-- Columnas de días con overlay absoluto para eventos -->
        <div *ngFor="let d of diasSemana()" class="day-col">
          <!-- rejilla de fondo por hora -->
          <div *ngFor="let h of horas" class="day-col__grid-cell"></div>
          <!-- overlay de eventos -->
          <div class="events-layer">
            <div *ngFor="let ev of eventosYHorarios()" [style.display]="estaEnDia(ev, d) ? 'block' : 'none'"
                 [style.top]="topPercent(ev)" [style.height]="heightPercent(ev)" [style.background]="ev.colorHex"
                 class="event"
                 (click)="abrirDetallesEvento(ev)">
              {{ ev.name }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <app-crear-evento *ngIf="mostrarModalCrear()" [eventosExistentes]="eventos()" [horariosExistentes]="horarios()" [eventoParaEditar]="eventoParaEditar()" (eventoCreado)="onEventoCreado()" (cerrar)="cerrarModalCrear()"></app-crear-evento>
  <app-crear-horario *ngIf="mostrarModalCrearHorario()" [horariosExistentes]="horarios()" [eventosExistentes]="eventos()" (horarioCreado)="onHorarioCreado()" (cerrar)="cerrarModalCrearHorario()"></app-crear-horario>
  <app-crear-evaluacion *ngIf="mostrarModalCrearEvaluacion()" [evaluacionParaEditar]="evaluacionParaEditar()" (evaluacionCreada)="onEvaluacionCreada()" (cerrar)="cerrarModalCrearEvaluacion()"></app-crear-evaluacion>

<!-- Modal Materias -->
<app-materias-modal *ngIf="mostrarModalMaterias()" (cerrar)="cerrarModalMaterias()"></app-materias-modal>
  
  <!-- Mensaje de error de búsqueda -->
  <div class="error-busqueda-overlay" *ngIf="mostrarErrorBusqueda()" (click)="mostrarErrorBusqueda.set(false)">
    <div class="error-busqueda-content" (click)="$event.stopPropagation()">
      <div class="error-busqueda-header">
        <svg class="error-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h3>No encontrado</h3>
      </div>
      <div class="error-busqueda-body">
        <p>{{ mensajeErrorBusqueda() }}</p>
      </div>
      <div class="error-busqueda-footer">
        <button type="button" class="error-busqueda-button" (click)="mostrarErrorBusqueda.set(false)">Entendido</button>
      </div>
    </div>
  </div>
  
  <!-- Modal de Detalles del Evento -->
  <div class="event-details-overlay" *ngIf="eventoSeleccionado()" (click)="cerrarDetallesEvento()">
    <div class="event-details-content" (click)="$event.stopPropagation()">
      <div class="event-details-header" [style.background]="eventoSeleccionado()?.colorHex || '#2196F3'">
        <h2>{{ eventoSeleccionado()?.name }}</h2>
      </div>
      <div class="event-details-body">
        <div class="event-detail-item" *ngIf="eventoSeleccionado()?.location">
          <div class="event-detail-label">Ubicación</div>
          <div class="event-detail-value">{{ eventoSeleccionado()?.location }}</div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Fecha</div>
          <div class="event-detail-value">{{ formatEventDate(eventoSeleccionado()?.startDateTime || '') }}</div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Hora</div>
          <div class="event-detail-value">
            {{ formatEventTime(eventoSeleccionado()?.startDateTime || '') }} - {{ formatEventTime(eventoSeleccionado()?.endDateTime || '') }}
          </div>
        </div>
        
        <div class="event-detail-item" *ngIf="eventoSeleccionado()?.description">
          <div class="event-detail-label">Descripción</div>
          <div class="event-detail-value">{{ eventoSeleccionado()?.description }}</div>
        </div>
      </div>
      <div class="event-details-footer">
        <button type="button" class="event-details-edit-btn" (click)="abrirEditarEvento()">Editar</button>
        <button type="button" class="event-details-delete-btn" (click)="eliminarEvento()">Eliminar</button>
        <button type="button" class="event-details-close-btn" (click)="cerrarDetallesEvento()">Cerrar</button>
      </div>
    </div>
  </div>

          <!-- Modal de Detalles de la Evaluación -->
          <div class="event-details-overlay" *ngIf="evaluacionSeleccionada()" (click)="cerrarDetallesEvento()">
            <div class="event-details-content" (click)="$event.stopPropagation()">
              <div class="event-details-header" [style.background]="evaluacionSeleccionada()?.colorHex || '#FF9800'">
                <h2>{{ evaluacionSeleccionada()?.titulo }}</h2>
              </div>
      <div class="event-details-body">
        <div class="event-detail-item">
          <div class="event-detail-label">Materia</div>
          <div class="event-detail-value">
            {{ evaluacionSeleccionada()?.materia?.nombre || evaluacionSeleccionada()?.materia }}
          </div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Nota</div>
          <div class="event-detail-value">{{ evaluacionSeleccionada()?.nota }}/20</div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Profesor</div>
          <div class="event-detail-value">{{ evaluacionSeleccionada()?.profesor }}</div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Ubicación</div>
          <div class="event-detail-value">{{ evaluacionSeleccionada()?.location }}</div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Fecha</div>
          <div class="event-detail-value">{{ formatEventDate(evaluacionSeleccionada()?.startDateTime || '') }}</div>
        </div>
        
        <div class="event-detail-item">
          <div class="event-detail-label">Hora</div>
          <div class="event-detail-value">
            {{ formatEventTime(evaluacionSeleccionada()?.startDateTime || '') }} - {{ formatEventTime(evaluacionSeleccionada()?.endDateTime || '') }}
          </div>
        </div>
        
        <div class="event-detail-item" *ngIf="evaluacionSeleccionada()?.descripcion">
          <div class="event-detail-label">Descripción</div>
          <div class="event-detail-value">{{ evaluacionSeleccionada()?.descripcion }}</div>
        </div>
      </div>
      <div class="event-details-footer">
        <button type="button" class="event-details-edit-btn" (click)="abrirEditarEvaluacion()">Editar</button>
        <button type="button" class="event-details-close-btn" (click)="cerrarDetallesEvento()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmación de Eliminación -->
  <div class="confirm-modal-overlay" *ngIf="mostrarConfirmacionEliminar()" (click)="cerrarConfirmacionEliminar()">
    <div class="confirm-modal-content" (click)="$event.stopPropagation()">
      <div class="confirm-modal-header">
        <svg class="confirm-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
        <h3>Confirmar Eliminación</h3>
      </div>
      <div class="confirm-modal-body">
        <p>¿Estás seguro de que deseas eliminar el evento <strong>"{{ eventoAEliminar()?.name }}"</strong>?</p>
        <p style="color: #d32f2f; font-weight: 600; margin-top: 8px;">Esta acción no se puede deshacer.</p>
      </div>
      <div class="confirm-modal-footer">
        <button type="button" class="confirm-modal-cancel-btn" (click)="cerrarConfirmacionEliminar()">Cancelar</button>
        <button type="button" class="confirm-modal-confirm-btn" (click)="confirmarEliminarEvento()">Eliminar</button>
      </div>
    </div>
  </div>
</div>


